To get a behavior dataset, run:
~/Dropbox/dynamic/check_rats/build_data_set_ephys.m

# How to run the code


# Define path to saved data

# Analysis things todo
Delta FR from tuning curve and PSTH, do they match?

Delta FR > 2 Hz plot. Is the start real, or some artifact. Make this plot from the SVD tuning curve. 

Make FR modulation with end of trial, not average?
Fit four parameter sigmoid for slope, then normalize
add poisson noise to fake cells, and noise from model trajectories

Sanity check for variance explained: look at PSTH for each cell with firing rate given left and right choice. Should be able to explain at least that much, right?

Make fake cells to estimate what is the % of variance that is explainable?

Make PSTH from tuning curve, how does it look?

Which rats does Ahmed want to use for recording?

Can you estimate attractor depth in my dataset and Tim's dataset by looking at encoding strength?
Weaker attractor == weaker encoding?
Can you calculate optimal encoding strength given switch frequency and estimated time remaining in trial?

Notes from Cosyne
    what would a sensory cell look like?
    low signal strength
    population analysis?
    can you optimize change points to maximize signal? How does that compare to behavior model predicted switch points?
    state triggered averages with random time points (this is shuffle analysis, right?)
    compare slopes and tuning curves to Hanks, 2015.
    What is relevant a-value scale for tuning curves? Can you compute the distribution of a values?
    need perturbation study
    alternative model from bings model to compare to
    do I see higher variance at end of trial. Check tuning curves and firing rate psths. 
    For RNN, add regularization for extra cells





Tuning Curves
    calculate population decoding from tuning curves assuming independent cells

    population average
        if I make the population average with raw firing rates, big cells dominate
        if I make the population average with normalized, its hard to interpret
        how do I make the population average?
    svd slope analysis
        H037:
        linear cells:   slope of 0.23
        step cells:     slope of 0.35
        H066:
        linear cells:   slope of 0.145 / 0.150
        step cells:     slope of 0.195 / 0.20
        H084:
        linear cells:   slope of 0.10
        step cells:     slope of 0.116
        H129:
        linear cells:   slope of 0.09
        step cells:     slope of 0.10

    1.look at each rat separately
        H066/H129 have more VE?
        compare slopes with each rat's linear/step slope.
    2.can we make STA predictions?
    3.compute VE or other goodness of fit metric
        is dv_axis centers or edges?
        fucking mean is wrong, but only sometimes??
        very small percentage explained....
        some cells with very negative VE....debug
        -- model getting something wrong on first time step, universally.
        find best of average_fr, average_avals, lag, etc
    4.2x cross validation to look to see if tuning curves are consistent?
    can we add more features to the tuning curves to improve VE/trial-by-trial predictions?

Repeat cells



FEB RETURN
    make excess click rates for each rat

Fig 1. supplement: instead of bing models, include Piet 2018 rats? or nothing? Could just have a table

PSTH 
    make ephys figure that looks like reverse correlation? like auto correlation for each cell
        subtract mean trajectory for each cell, then compute auto correlation? 
        Compare timescale with generative state dwell time, and model dwell time.
    percent of cells that are side selective at any time point
        could compute d' for each cell, for each time point
        goal would be to see emergence of choice signal at end of trial?

CLICK TRIGGERED AVERAGES
    repeat STA analysis aligned to clicks 

STATE TRIGGERED AVERAGES
    Quantify alignment to model vs generative state
    Use logistic regression to decode generative/model states from STA, and compute a population d'
    Use logistic regression to predict choice
    Early vs. late STA
    Strong vs. weak STA
    Two switches in a row STA
    Multiple comparison corrections, use shuffles to determine frequency because time bins are correlated
    Switch times
        switch times are not well defined for cells with only one significant field, remove those cells?
        for no_map flip cells, could have switch at start as well
        Can you have a better documentation and description of different cases for switch times
        Compute switch times, and % of cells that are consistent encoders only computing STA on a (-0.5, 0.5) window 

TUNING CURVES
    Characterize tuning curve slopes and fr.modulation across time and across cells
    
    Variance Explained by rank 1 model
        1. a model with mean temporal trajectory   
        2. a model with mean temporal trajectory + tuning curve for each bin
        3. a model with mean temporal trajectory + mean fr.modulation*avg. tuning curve
        Use cross validation

    Population decoding
        1. best decoding of "a" or states from tuning curves assuming fixed, even, weights
        2. best decoding using weighted average of cells
        3. best decoding assuming time-varying weights that don't change sign
        4. best decoding assuming time-varying weights that can change sign
        How smooth are time-dynamic weights?
   
    DEBUGGING
        need to compute model distribution for more cells
        double check trial alignment, trial durations are very rarely diff.
        cell 18195, crashes because firing rate vector is wrong size...
        fix plot_population, and population_analysis to handle the case with no good cells

    PARAMETERS TO CHANGE
        param_scale_factor
        param_scale_num
  
    VERIFICATION
        map synthetic neurons with different slopes onto recovered slopes
            document dependence on accumulation noise, each rat has different mapping. 
        can I recover non-monotonic tuning curves?
        Are tuning curves consistent with STA?

    METHOD
        make sure you understand how Pjoint is transformed into fga_cell       
        weird transients at start of trial, should we ignore first bins?     
        need to handle more data points for earlier time points

    BINNING
        handle variable a-bins
        implement lag with time averaging 
        implement mt_offset with time averaging

    SINGLE CELL
        Quantify each time bin's encoding strength
        How stable is each cell's encoding strength over time?     
        fit sigmoid to entire fga_residual, not time-averaged version

    POPULATION LEVEL
        instead of picking good cells by fr modulation. 
            put error bars on the un-normalized sigmoid
            do a statistical test for the min and max values.
        compute population sigmoid error bars by incorporating error from each cell, rather than error of average. 
        population decoding from tuning curves
            quantify how good the fits are at predicting generative/model state, and choice.
        Need to figure out how to combine side-switching cells
        figure out variance weight approach
            can we weight each time bin separately, which might handle side-switching cells? 
     
PIPELINE
    check cpoke time = stim time
    debug no cpoke and no sound_on trials
    Criteria for inclusion: mean stimulus fr > 0.5 hz
    Should we include violation trials? Right now, we are not

CODE BASE
    reload data from tyler because I might have fucked up a cell
    Make one plotting function that shows model tuning curves, and PSTH/State changes in one figure

VARIABILITY
    Does network stabilize over time? might want to draw on standard task and MGO data as well
    What can we infer about an energy landscape?
    fano factor as a function of a-value
     
FITTING NETWORK MODELS
    Can we use tuning curve models to fit a population network?
    fit trial to trial data 
    fit with poisson observations
    What happens with perturbations?
    What happens with non-targeted cells? 
    
OPTIONAL PROJECTS
    How synchronized are state changes across cells?
    deconvolve tuning curves with estimated variance
    calculate probability flux across a boundary, not just net probability
    Brians method
    Two state hidden Markov Model
    can we make a pseudo-population for PCA using accumulation model?    

